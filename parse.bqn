âŸ¨Journal, ParseJournal, ParseJournalPricesâŸ©â‡

Flatten â† {(âˆ¾ğ•ŠÂ¨)âŸ(1<â‰¡)â¥Šğ•©}
Trim â† {(âˆ¨`âˆ§âˆ¨`âŒ¾âŒ½)' 'â‰ ğ•©}âŠ¸/
RemEmpty â† {ğ•©/Ëœ0â‰ â‰ Â¨ğ•©}

F â† {0âŠ‘ğ•©}
R â† {1â†“ğ•©}
E â† {""â‰¡ğ•©}

I    â† {âŸ¨"", ğ•©âŸ©}
Fail â† {ğ•¤ â‹„ âŸ¨-1, ""âŸ©}
Any  â† {Â¬E ğ•© ? âŸ¨F ğ•©, R ğ•©âŸ© ; Fail 1}
Err  â† {âŸ¨-1, ""âŸ©â‰¡ğ•©}

_and_ â† {m0â€¿r0 â† ğ”½ ğ•© â‹„ Â¬Err m0â€¿r0 ? m1â€¿r1 â† ğ”¾ r0 â‹„ {Â¬Err m1â€¿r1 ? âŸ¨âŸ¨m0, m1âŸ©, r1âŸ© ; Fail 1} ; Fail 1}
_or_  â† {r â† ğ”½ ğ•© â‹„ Â¬Err r ? r ; ğ”¾ ğ•©}

_mb       â† {r â† ğ”½ ğ•© â‹„ Â¬Err r ? r ; I ğ•©}
_mb_rep   â† {mâ€¿r â† ğ”½ ğ•© â‹„ Â¬Err mâ€¿r ? m0â€¿r0 â† ğ•Š r â‹„ âŸ¨mâˆ¾m0, r0âŸ©; I ğ•©}
_rep      â† {mâ€¿r â† ğ”½ ğ•© â‹„ Â¬Err mâ€¿r ? m0â€¿r0 â† ğ”½ _mb_rep r â‹„ âŸ¨mâˆ¾m0, r0âŸ© ; Fail 1}
_rep_sep_ â† {ğ”½ _and_ ((ğ”¾ _and_ ğ”½) _mb_rep)}

_tf       â† {Â¬Err ğ•© ? mâ€¿r â† ğ•© â‹„ âŸ¨ğ”½ m, râŸ© ; ğ•©}
Listify   â† {âŸ¨e0, eâŸ© : (<e0)âˆ¾e}

End     â† {E ğ•© ? I ğ•© ; Fail 1}

String  â† {ğ•¨â‰¡(â‰ ğ•¨)â†‘ğ•© ? âŸ¨ğ•¨, (â‰ ğ•¨)â†“ğ•©âŸ© ; Fail 1}

CC      â† {mâ€¿r â† Any ğ•© â‹„ (âŠ‘mâˆŠğ•¨)âˆ§Â¬Err mâ€¿r ? mâ€¿r ; Fail 1}
NotCC   â† {mâ€¿r â† Any ğ•© â‹„ (Â¬âŠ‘mâˆŠğ•¨)âˆ§Â¬Err mâ€¿r ? mâ€¿r ; Fail 1}
Until   â† {s â† (ğ•¨â·ğ•©)Â»0â¥ŠËœâ‰ ğ•© â‹„ âˆ¨Â´s ? mâ€¿r â† {ğ•©âŠ”Ëœ0<+`s} ğ•© â‹„ âŸ¨m,râŸ©; Fail 1}
Digit   â† {('0'+â†•10) CC ğ•©}
Lower   â† {('a'+â†•26) CC ğ•©}
Upper   â† {('A'+â†•26) CC ğ•©}
Char    â† Upper _or_ Lower
Numeric â† {â€¢ParseFloat ğ•©} _tf Digit _rep
Lf      â† "" _tf {âŸ¨@+10âŸ© CC ğ•©}
NotLF   â† {âŸ¨@+10âŸ© NotCC ğ•©}
LfOrEnd â† Lf _or_ End
Rest    â† {End _or_ (NotLF _mb_rep) ğ•©}

DecSep  â† {"." CC ğ•©}
Float   â† {â€¢ParseFloat >Flatten ğ•©} _tf (Digit _rep) _and_ ((DecSep _and_ (Digit _rep)) _mb)

Space   â† {" " CC ğ•©}
DateSep â† {"/-." CC ğ•©}
Status  â† {"*!" CC ğ•©}
Eq      â† {"=" CC ğ•©}
Sign    â† {"-" CC ğ•©}
YMD     â† {âŸ¨âŸ¨âŸ¨âŸ¨y, Â·âŸ©, mâŸ©, Â·âŸ©, dâŸ© : yâ€¿mâ€¿d} _tf Numeric _and_ DateSep _and_ Numeric _and_ DateSep _and_ Numeric

NoSpace  â† {(" "âˆ¾@+10) NotCC ğ•©}
Quote    â† {"""" CC ğ•©}
Enclosed â† {âŸ¨âŸ¨Â·, râŸ©, Â·âŸ© : r} _tf Quote _and_ ({"""" NotCC ğ•©} _rep) _and_ Quote
TAcode   â† (Char _or_ Digit )_rep

EqYMDOpt  â† {1<â‰ ğ•© ? 1âŠ‘ğ•© ; ""} _tf (Eq _and_ YMD) _mb
StatusOpt â† {0<â‰ ğ•© ? âŠ‘ğ•© ; ""} _tf (Status _and_ Space) _mb
TACodeOpt â† {0<â‰ ğ•© ? âŸ¨âŸ¨âŸ¨Â·, sâŸ©, Â·âŸ©, Â·âŸ© â† ğ•© â‹„ s ; ""} _tf ({"(" String ğ•©} _and_ TACode _and_ {")" String ğ•©} _and_ Space) _mb

NoComm â† {(";"âˆ¾@+10) NotCC ğ•©} _mb_rep
Comm   â† {0<â‰ ğ•© ? 1âŠ‘ğ•© ; ""} _tf { ";" CC ğ•©} _and_ Rest

PHeader â† YMD _and_ EqYMDOpt _and_ Space _and_ StatusOpt _and_ TACodeOpt _and_ NoComm _and_ (Comm _mb)
Header  â† {âŸ¨âŸ¨âŸ¨âŸ¨âŸ¨âŸ¨y, y1âŸ©, Â·âŸ©, sâŸ©, tâŸ©, câŸ©, Â·âŸ© : âŸ¨y, y1, s, t, câŸ©} _tf PHeader

Num          â† Float _or_ Numeric
Symb         â† {("0123456789-.@; """âˆ¾@+10) NotCC ğ•©}
Symbs        â† Symb _rep
Spaces       â† Space _rep
#SymbsSpaces  â† Flatten _tf Symbs _and_ ((Spaces _and_ Symbs) _mb_rep)
Com          â† Symbs _or_ Enclosed
SpaceMB      â† "" _tf Space _mb
# Box the return since -1 is valid
SignsSpaceMB â† {âŸ¨n, Â·âŸ© : <Â¯1â‹†â‰ n} _tf ((Sign _mb_rep) _and_ (Space _mb_rep))

AmountSNC   â† {âŸ¨âŸ¨âŸ¨s, aâŸ©, Â·âŸ©, câŸ© : âŸ¨âŠ‘s, a, câŸ©} _tf SignsSpaceMB _and_ Num _and_ SpaceMB _and_ Com
AmountSCN   â† {âŸ¨âŸ¨âŸ¨s, câŸ©, Â·âŸ©, aâŸ© : âŸ¨âŠ‘s, a, câŸ©} _tf SignsSpaceMB _and_ (Com _mb) _and_ SpaceMB _and_ Num
AmountCSN   â† {âŸ¨âŸ¨âŸ¨âŸ¨c, Â·âŸ©, sâŸ©, Â·âŸ©, aâŸ© : âŸ¨âŠ‘s, a, câŸ©} _tf (Com _mb) _and_ SpaceMB _and_ SignsSpaceMB _and_ SpaceMB _and_ Num
Amount      â† AmountSNC _or_ AmountSCN _or_ AmountCSN
PriceAmount â† {âŸ¨âŸ¨âŸ¨Â·, tâŸ©, Â·âŸ©, aâŸ© : â‹„ âŸ¨t, aâŸ©} _tf (Spaces _and_ ({"@@" String ğ•©} _or_ {"@" String ğ•©}) _and_ Spaces _and_ Amount)

Comment  â† âŸ¨"c"âŸ© _tf Space _mb_rep _and_ Comm

Account       â† âŠ‘ _tf (Listify _tf ((Symb _rep) _rep_sep_ {":" String ğ•©}))

PostingAmount â† {âŸ¨âŸ¨âŸ¨âŸ¨acc, Â·âŸ©, Â·âŸ©, amâŸ©, am0âŸ© : â‹„ âŸ¨Trim acc, am, am0âŸ©} _tf (Account _and_ Space _and_ Spaces _and_ Amount _and_ (PriceAmount _mb))
PostingCom    â† "" _tf Comm
PostingEmpty  â† {âŸ¨Trim ğ•©, âŸ¨1, 0, -1âŸ©, âŸ¨âŸ©âŸ©} _tf Rest
Posting       â† {âŸ¨Â·, râŸ© : r} _tf Spaces _and_ (PostingAmount _or_ PostingCom _or_ PostingEmpty)
Postings      â† RemEmpty _tf (Listify _tf (Posting _rep_sep_ Lf))

EmptyLine    â† "c" _tf Space _mb_rep
Entry        â† {âŸ¨âŸ¨âŸ¨h, Â·âŸ©, pâŸ©, Â·âŸ© : âŸ¨"e", âŸ¨âŸ¨h, pâŸ©âŸ©âŸ©} _tf Header _and_ Lf _and_ Postings _and_ ((Lf _and_ EmptyLine) _or_ End)
Include      â† {âŸ¨Â·, fâŸ© : â‹„ âŸ¨"i", âŠ‘Journal â€¢FChars fâŸ©} _tf ({"include " String ğ•©} _and_ Rest)
PriceLine    â† {âŸ¨âŸ¨âŸ¨âŸ¨âŸ¨Â·, dâŸ©, Â·âŸ©, câŸ©, Â·âŸ©, nâŸ©: âŸ¨"p", âŸ¨d, âŸ¨00, 00âŸ©, c, nâŸ©âŸ©} _tf {"P " String ğ•©} _and_ YMD _and_ Spaces _and_ Com _and_ Spaces _and_ Amount
JournalEntry â† Include _or_ Entry _or_ PriceLine _or_ Comment

Journal       â† {âŸ¨h, tâŸ©: (<h)âˆ¾âˆ¾Â´<Â¨t} _tf (JournalEntry _rep_sep_ ((EmptyLine _and_ Lf) _mb_rep))
KeepEntries   â† {âŠ‘Â¨âŠ‘Â¨1â†“Â¨ğ•©/Ëœ(âŠ‘Â¨ğ•©)âˆŠ"e"â€¿"i"}
KeepPrices    â† {âŠ‘Â¨1â†“Â¨ğ•©/Ëœ(âŠ‘Â¨ğ•©)âˆŠâ‹ˆ"p"}
JournalMatrix â† {(>(â†•â‰ ğ•©)âˆ¾Â¨0âŠ‘Â¨ğ•©)â€¿(>((â†•â‰ ğ•©)/Ëœâ‰ Â¨1âŠ‘Â¨ğ•©)âˆ¾Â¨âˆ¾1âŠ‘Â¨ğ•©)}
ParseJournal  â† {JournalMatrix KeepEntries âŠ‘Journal ğ•©}
ParseJournalPrices â† {j â† Journal ğ•© â‹„ (JournalMatrix KeepEntries âŠ‘j)âˆ¾<>KeepPrices âŠ‘j}
