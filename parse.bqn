Flatten â† {(âˆ¾ğ•ŠÂ¨)âŸ(1<â‰¡)â¥Šğ•©}
Trim â† {(âˆ¨`âˆ§âˆ¨`âŒ¾âŒ½)' 'â‰ ğ•©}âŠ¸/
RemEmpty â† {âŠ‘ğ•©âŠ”Ëœ1-Ëœ0â‰ â‰ Â¨ğ•©}

F â† {0âŠ‘ğ•©}
R â† {1â†“ğ•©}
E â† {""â‰¡ğ•©}

I    â† {âŸ¨"", ğ•©âŸ©}
Fail â† {ğ•¤ â‹„ âŸ¨-1, ""âŸ©}
Any  â† {Â¬E ğ•© ? âŸ¨F ğ•©, R ğ•©âŸ© ; Fail 1}
Err  â† {âŸ¨-1, ""âŸ©â‰¡ğ•©}

_and_ â† {m0â€¿r0 â† ğ”½ ğ•© â‹„ Â¬Err m0â€¿r0 ? m1â€¿r1 â† ğ”¾ r0 â‹„ {Â¬Err m1â€¿r1 ? âŸ¨âŸ¨m0, m1âŸ©, r1âŸ© ; Fail 1} ; Fail 1}
_or_  â† {r â† ğ”½ ğ•© â‹„ Â¬Err r ? r ; ğ”¾ ğ•©}

_mb       â† {r â† ğ”½ ğ•© â‹„ Â¬Err r ? r ; I ğ•©}
_mb_rep   â† {mâ€¿r â† ğ”½ ğ•© â‹„ Â¬Err mâ€¿r ? m0â€¿r0 â† ğ•Š r â‹„ âŸ¨mâˆ¾m0, r0âŸ©; I ğ•©}
_rep      â† {mâ€¿r â† ğ”½ ğ•© â‹„ Â¬Err mâ€¿r ? m0â€¿r0 â† ğ”½ _mb_rep r â‹„ âŸ¨mâˆ¾m0, r0âŸ© ; Fail 1}
_rep_sep_ â† {ğ”½ _and_ ((ğ”¾ _and_ ğ”½) _mb_rep)}

_tf       â† {Â¬Err ğ•© ? mâ€¿r â† ğ•© â‹„ âŸ¨ğ”½ m, râŸ© ; ğ•©}
Listify   â† {âŸ¨e0, eâŸ© â† ğ•© â‹„ (<e0)âˆ¾e}

Lf      â† {""} _tf {âŸ¨@+10âŸ© CC ğ•©}
NotLF   â† {âŸ¨@+10âŸ© NotCC ğ•©}
End     â† {E ğ•© ? I ğ•© ; Fail 1}
LfOrEnd â† Lf _or_ End
Rest    â† {End _or_ (NotLF _mb_rep) ğ•©}

String  â† {ğ•¨â‰¡(â‰ ğ•¨)â†‘ğ•© ? âŸ¨ğ•¨, (â‰ ğ•¨)â†“ğ•©âŸ© ; Fail 1}

CC      â† {mâ€¿r â† Any ğ•© â‹„ (âŠ‘mâˆŠğ•¨)âˆ§Â¬Err mâ€¿r ? mâ€¿r ; Fail 1}
NotCC   â† {mâ€¿r â† Any ğ•© â‹„ (Â¬âŠ‘mâˆŠğ•¨)âˆ§Â¬Err mâ€¿r ? mâ€¿r ; Fail 1}
Until   â† {s â† (ğ•¨â·ğ•©)Â»0â¥ŠËœâ‰ ğ•© â‹„ âˆ¨Â´s ? mâ€¿r â† {ğ•©âŠ”Ëœ0<+`s} ğ•© â‹„ âŸ¨m,râŸ©; Fail 1}
Digit   â† {('0'+â†•10) CC ğ•©}
Lower   â† {('a'+â†•26) CC ğ•©}
Upper   â† {('A'+â†•26) CC ğ•©}
Char    â† Upper _or_ Lower
Numeric â† {â€¢ParseFloat ğ•©} _tf Digit _rep

DecSep  â† {"." CC ğ•©}
Float   â† {â€¢ParseFloat >Flatten ğ•©} _tf (Digit _rep) _and_ ((DecSep _and_ (Digit _rep)) _mb)

Space   â† {" " CC ğ•©}
DateSep â† {"/-." CC ğ•©}
Status  â† {"*!" CC ğ•©}
Eq      â† {"=" CC ğ•©}
Sign    â† {"-" CC ğ•©}
YMD     â† {âŸ¨âŸ¨âŸ¨âŸ¨y, Â·âŸ©, mâŸ©, Â·âŸ©, dâŸ© â† ğ•© â‹„ yâ€¿mâ€¿d} _tf Numeric _and_ DateSep _and_ Numeric _and_ DateSep _and_ Numeric

NoSpace  â† {(" "âˆ¾@+10) NotCC ğ•©}
Quote    â† {"""" CC ğ•©}
Enclosed â† {âŸ¨âŸ¨Â·, râŸ©, Â·âŸ© â† ğ•© â‹„ r} _tf Quote _and_ ({"""" NotCC ğ•©} _rep) _and_ Quote
TAcode   â† Enclosed _or_ (NoSpace _rep)

EqYMDOpt  â† {1<â‰ ğ•© ? 1âŠ‘ğ•© ; ""} _tf (Eq _and_ YMD) _mb
StatusOpt â† {0<â‰ ğ•© ? âŠ‘ğ•© ; ""} _tf (Status _and_ Space) _mb
TACodeOpt â† {0<â‰ ğ•© ? âŠ‘ğ•© ; ""} _tf (TACode _and_ Space) _mb

NoComm â† {(";"âˆ¾@+10) NotCC ğ•©} _mb_rep
Comm   â† {0<â‰ ğ•© ? 1âŠ‘ğ•© ; ""} _tf { ";" CC ğ•©} _and_ Rest

PHeader â† YMD _and_ EqYMDOpt _and_ Space _and_ StatusOpt _and_ TACodeOpt _and_ NoComm _and_ (Comm _mb)
Header  â† {âŸ¨âŸ¨âŸ¨âŸ¨âŸ¨âŸ¨y, y1âŸ©, Â·âŸ©, sâŸ©, tâŸ©, câŸ©, Â·âŸ© â† ğ•© â‹„ âŸ¨y, y1, s, t, câŸ©} _tf PHeader

Num         â† Float _or_ Numeric
Symb        â† {("0123456789-.@; """âˆ¾@+10) NotCC ğ•©}
Symbs       â† Symb _rep
Spaces      â† Space _rep
SymbsSpaces â† Flatten _tf Symbs _and_ ((Spaces _and_ Symbs) _mb_rep)
Com         â† SymbsSpaces _or_ Enclosed
SpaceMB     â† {""} _tf Space _mb
SignSpaceMB â† {Â¬""â‰¡ğ•© ? {'-'=0âŠ‘ğ•© ? -1 ; 1} ğ•© ; 1} _tf (Sign _and_ SpaceMb) _mb

AmountSNC  â† {âŸ¨âŸ¨âŸ¨s, aâŸ©, Â·âŸ©, câŸ© â† ğ•© â‹„ âŸ¨s, a, câŸ©} _tf SignSpaceMB _and_ Num _and_ SpaceMB _and_ Com
AmountSCN  â† {âŸ¨âŸ¨âŸ¨s, câŸ©, Â·âŸ©, aâŸ© â† ğ•© â‹„ âŸ¨s, a, câŸ©} _tf SignSpaceMB _and_ (Com _mb) _and_ SpaceMB _and_ Num
AmountCSN  â† {âŸ¨âŸ¨âŸ¨âŸ¨c, Â·âŸ©, sâŸ©, Â·âŸ©, aâŸ© â† ğ•© â‹„ âŸ¨s, a, câŸ©} _tf (Com _mb) _and_ SpaceMB _and_ SignSpaceMB _and_ SpaceMB _and_ Num
Amount     â† AmountSNC _or_ AmountSCN _or_ AmountCSN
CostAmount â† {Â¯1â†‘ğ•©} _tf (Spaces _and_ {"@" String ğ•©} _and_ Spaces _and_ Amount)

Comment  â† {âŸ¨""âŸ©} _tf Space _mb_rep _and_ Comm

Account       â† âŠ‘ _tf (Listify _tf ((Symb _rep) _rep_sep_ {":" String ğ•©}))

PostingAmount â† {âŸ¨âŸ¨âŸ¨âŸ¨acc, Â·âŸ©, Â·âŸ©, amâŸ©, am0âŸ© â† ğ•© â‹„ âŸ¨Trim acc, amâŸ©} _tf (Account _and_ Space _and_ Spaces _and_ Amount _and_ (CostAmount _mb))
PostingCom    â† {""} _tf Comm
PostingEmpty  â† {âŸ¨Trim ğ•©, âŸ¨1, 0, -1âŸ©âŸ©} _tf Rest
Posting       â† {âŸ¨Â·, râŸ© â† ğ•© â‹„ r} _tf Spaces _and_ (PostingAmount _or_ PostingCom _or_ PostingEmpty)
Postings      â† RemEmpty _tf (Listify _tf (Posting _rep_sep_ Lf))

EmptyLine    â† {""} _tf Space _mb_rep
Entry        â† {âŸ¨âŸ¨âŸ¨h, Â·âŸ©, pâŸ©, Â·âŸ© â† ğ•© â‹„ âŸ¨âŸ¨h, pâŸ©âŸ©} _tf Header _and_ Lf _and_ Postings _and_ ((Lf _and_ EmptyLine) _or_ End)
Include      â† {âŸ¨Â·, fâŸ© â† ğ•© â‹„ âŠ‘Journal â€¢FChars f} _tf ({"include " String ğ•©} _and_ Rest)
JournalEntry â† Include _or_ Entry _or_ Comment

Journal      â† RemEmpty _tf ({âŸ¨e0, eâŸ© â† ğ•© â‹„ âˆ¾âŸ¨e0âŸ©âˆ¾e} _tf (JournalEntry _rep_sep_ ((EmptyLine _and_ Lf) _mb_rep)))
ParseJournal â† {j â† âŠ‘Journal ğ•© â‹„ (>(â†•â‰ j)âˆ¾Â¨0âŠ‘Â¨j)â€¿(>((â†•â‰ j)/Ëœâ‰ Â¨1âŠ‘Â¨j)âˆ¾Â¨âˆ¾1âŠ‘Â¨j)}

input â† â€¢FChars "test_journal.ledger"

jâ€¿k â† ParseJournal input

AmountCols â† {
		   # commodity per TA
		   t â† âˆ¾2â†“Â¨2âŠË˜ğ•©
		   
		   # unique commodities
		   com â† âŠ‘tâŠ”Ëœ1-ËœâˆŠt
		   
		   # amount array by commodities
		   am â† (Ã—Â´Ë˜âŠ‘Ë˜2â†‘Â¨2â†“Ë˜ğ•©)Ã—tâ‰¡âŒœcom
		   
		   comâ€¿am
}

comâ€¿am â† AmountCols k

# empty TAs are used for balancing
e â† 0=+Â´Ë˜am

# add empty posting fallback
em â† (1â†‘Ë˜j)(Â¬âˆ˜âˆŠ/âŠ£)(e/1â†‘Ë˜k)

# add fallback rows at end and put them to right position
tmp â† kâˆ¾(â‰âˆ¾â‰Â¨âŸ¨em,(â‰ em)/â‰"System:Error"â€¿âŸ¨1, 0, -1âŸ©âŸ©)
k0 â† tmpâŠËœâ‹({ğ•©â‰¡âŸ¨1, 0, -1âŸ©}Â¨(2â†“Ë˜tmp))+2Ã—1â†‘Ë˜tmp

com0â€¿am0 â† AmountCols k0

# balanced TAs
bal â† am+Â¯1Ã—-âŸœÂ»âŒˆ`(0=+Â´Ë˜am)Ã—+`am

# multiple commodities unbalanced
1<+Â´Ë˜0â‰ bal
