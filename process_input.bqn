âŸ¨ProcessInputâŸ©â‡

err â† "Error"
of â† 1â€¿0â€¿Â¯1

# Amounts to columns by commodity
AddCommodityCols â† {
    # commodity per TA
	t  â† âŠ‘Â¨2â†“Â¨2âŠË˜ğ•©
	# unique commodities
	com â† â·t
	# amount array by commodities
	am â† (Ã—Â´Ë˜âŠ‘Ë˜2â†‘Â¨2â†“Ë˜ğ•©)Ã—tâ‰¡âŒœcom
	comâ€¿am
}

RemCommodityCols â† {(<Â¨(â‰ ğ•¨)/1â†‘Ë˜ğ•©)âˆ¾Â¨â¥Š<Â¨(âŸ¨â‰ ğ•©, â‰ ğ•¨âŸ©â¥Š1)âˆ¾Â¨(<Â¨âŸ¨â‰ ğ•©, â‰ ğ•¨âŸ©â¥Šğ•¨)âˆ¾Â¨(1â†“Ë˜ğ•©)}
	
# Overflow rows for balancing
AddErrorRows â† {
    amâ€¿jâ€¿k :
	# empty TAs are used for balancing
	e â† 0=+Â´Ë˜am
	# add empty posting fallback
	em â† (1â†‘Ë˜j)(Â¬âˆ˜âˆŠ/âŠ£)(e/1â†‘Ë˜k)
	# append fallback rows 
	t â† kâˆ¾(âˆ¾â‰âŸ¨em,(â‰ em)/â‰âŸ¨err, of, âŸ¨âŸ©âŸ©âŸ©)
	# put fallback rows to right index
	tâŠËœâ‹({ğ•©â‰¡of}Â¨(2âŠË˜t))+2Ã—1â†‘Ë˜t
}

# Find balancing errors
BalancingErrors â† {
    âŸ¨k, bâŸ©:
	# an error row may contain a currency exchange	
	e0 â† ({errâ‰¡ğ•©}Â¨1âŠË˜k)âˆ§Â¬({0=+Â´ğ•©}âˆ§{2=+Â´|Â¨ğ•©})Ë˜Ã—Â¨2â†“Ë˜b
	# an overflow row may contain one currency
	o0 â† {({ofâ‰¡ğ•©}Â¨2âŠË˜k)âˆ§Â¬{errâ‰¡ğ•©}Â¨1âŠË˜k}Ã—Â¬({2>+Â´|Â¨ğ•©})Ë˜Ã—Â¨2â†“Ë˜b
	m â† b/Ëœ0<Â¨e0+o0
}

# match ğ•© to ğ•¨ based on id in first col of each
MatchFirst â† {âŸ¨ğ•¨,ğ•©âŠËœğ•¨âŠâ—‹(âŠ‘Ë˜)ğ•©âŸ©}
RemErrorRows â† {ğ•©/Ëœ{errâ‰¢ğ•©}Â¨1âŠË˜ğ•©}

# add inverted sum of previous postings where sum of row is 0 (= virtual overflow posting)
BalanceTAs â† {amâ€¿k0 : e â† 0=+Â´Ë˜am â‹„ âˆ¾â‰âŸ¨2â†‘Ë˜k0, (--âŸœÂ»e/+`am)âŒ¾(eâŠ¸/)amâŸ©}

ExtractPrices â† {
    jâ€¿comâ€¿bal :
	# index of last posting per ta
	l â† 1âŒ¾(Â¯1âŠ¸âŠ‘)<âŸœÂ«â¥Š1â†‘Ë˜bal
	# balance tas
	c â† -âŸœÂ»l/+`2â†“Ë˜bal
	# two commodities in one posting
	i â† 2=+Â´Ë˜0â‰ c
	# matching transaction data
	t â† 1âŠ‘j MatchFirstËœ i/l/1â†‘Ë˜bal
	# commodities
	cs â†(0â‰ i/c){ğ•¨/âŠ‘ğ•©}Ë˜(+Â´i)â¥Š<com
	# amounts
	ams â† {hâ€¿t : Â¯1Ã—tÃ·h}Â¨(1-Ëœ0â‰ i/c)âŠ”Ë˜i/c
	# build and return table
	d â† âˆ¾â‰âŸ¨1âŠ‘Ë˜t, (+Â´i)â€¿1â¥Š<âŸ¨00, 00âŸ©, cs, amsâŸ©
	â†‘â€¿4â¥Š{yâ€¿mâ€¿dâ€¿tâ€¿cfâ€¿ctâ€¿am : âŸ¨y, m, dâŸ©â€¿tâ€¿âŸ¨1, 1, cfâŸ©â€¿âŸ¨1, am, ctâŸ©}Ë˜d
}

# swap position of a/c and change base to new first a/c
ReversePrice â† {dâ€¿tâ€¿âŸ¨fs, fa, fcâŸ©â€¿âŸ¨ts, ta, tcâŸ© : dâ€¿tâ€¿âŸ¨ts, taÃ·ta, tcâŸ©â€¿âŸ¨fs, faÃ·ta, fcâŸ©}

ProcessInput â† {
    jâ€¿kâ€¿p :
    comâ€¿am â† AddCommodityCols k
	k0 â† AddErrorRows amâ€¿jâ€¿k
	comâ€¿am â†© AddCommodityCols k0
	bal â† BalanceTAs amâ€¿k0
	errs â† â‰âˆ¾â‰Â¨j MatchFirstËœ BalancingErrors k0â€¿bal
	bal â†© RemErrorRows bal
	prices â† âˆ¾âŸœ(ReversePriceË˜) pâˆ¾ExtractPrices jâ€¿comâ€¿bal
	âŸ¨com, bal, prices, errsâŸ©
}