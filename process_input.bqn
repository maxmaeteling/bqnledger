âŸ¨ProcessInputâŸ©â‡

err â† "Error"
of â† 1â€¿0â€¿Â¯1

# Amounts to columns by commodity
AddCommodityCols â† {
			  # commodity per TA
			  t  â† âŠ‘Â¨2â†“Â¨2âŠË˜ğ•©
			  # unique commodities
			  com â† â·t
			  # amount array by commodities
			  am â† (Ã—Â´Ë˜âŠ‘Ë˜2â†‘Â¨2â†“Ë˜ğ•©)Ã—tâ‰¡âŒœcom
			  comâ€¿am
}

RemCommodityCols â† {(<Â¨(â‰ ğ•¨)/1â†‘Ë˜ğ•©)âˆ¾Â¨â¥Š<Â¨(âŸ¨â‰ ğ•©, â‰ ğ•¨âŸ©â¥Š1)âˆ¾Â¨(<Â¨âŸ¨â‰ ğ•©, â‰ ğ•¨âŸ©â¥Šğ•¨)âˆ¾Â¨(1â†“Ë˜ğ•©)}
	
# Overflow rows for balancing
AddErrorRows â† {
	  amâ€¿jâ€¿k :
	  # empty TAs are used for balancing
	  e â† 0=+Â´Ë˜am
	  # add empty posting fallback
	  em â† (1â†‘Ë˜j)(Â¬âˆ˜âˆŠ/âŠ£)(e/1â†‘Ë˜k)
	  # append fallback rows 
	  t â† kâˆ¾(â‰âˆ¾â‰Â¨âŸ¨em,(â‰ em)/â‰âŸ¨err, of, âŸ¨âŸ©âŸ©âŸ©)
	  # put fallback rows to right index
	  tâŠËœâ‹({ğ•©â‰¡of}Â¨(2âŠË˜t))+2Ã—1â†‘Ë˜t
}

# Find balancing errors
BalancingErrors â† {
				âŸ¨k, bâŸ©:
				# an error row may contain a currency exchange	
				e0 â† ({errâ‰¡ğ•©}Â¨1âŠË˜k)âˆ§Â¬({0=+Â´ğ•©}âˆ§{2=+Â´|Â¨ğ•©})Ë˜Ã—Â¨2â†“Ë˜b
				# an overflow row may contain one currency
				o0 â† {({ofâ‰¡ğ•©}Â¨2âŠË˜k)âˆ§Â¬{errâ‰¡ğ•©}Â¨1âŠË˜k}Ã—Â¬({2>+Â´|Â¨ğ•©})Ë˜Ã—Â¨2â†“Ë˜b
				m â† b/Ëœ0<Â¨e0+o0
}

# match ğ•© to ğ•¨ based on id in first col
MatchFirst â† {âŸ¨ğ•¨,ğ•©âŠËœğ•¨âŠâ—‹(âŠ‘Ë˜)ğ•©âŸ©}

RemErrorRows â† {ğ•©/Ëœ{errâ‰¢ğ•©}Â¨1âŠË˜ğ•©}

BalanceTAs â† {â‰âˆ¾â‰Â¨âŸ¨2â†‘Ë˜ğ•©, ğ•¨+Â¯1Ã—-âŸœÂ»{ğ•¨>â—‹|ğ•©?ğ•¨;ğ•©}`(0=+Â´Ë˜ğ•¨)Ã—+`ğ•¨âŸ©}

ProcessInput â† {
			 comâ€¿am â† AddCommodityCols ğ•©
			 k0 â† AddErrorRows amâ€¿ğ•¨â€¿ğ•©
			 comâ€¿am â†© AddCommodityCols k0
			 bal â† am BalanceTAs k0
			 errs â† ğ•¨ MatchFirstËœ BalancingErrors âŸ¨k0, balâŸ©				 
			 bal â†© RemErrorRows bal
			 âŸ¨com, bal, errsâŸ©
}