âŸ¨Journal, ParseJournalâŸ© â‡ â€¢Import "parse.bqn"

âŸ¨ReportBalâŸ© â‡â€¢Import "report_bal.bqn"

input â† â€¢FChars "test.ledger"

jâ€¿k â† ParseJournal input

err â† "Error"
of â† 1â€¿0â€¿Â¯1

# Amounts to columns by commodity
CommodityCols â† {
			  # commodity per TA
			  t  â† âŠ‘Â¨2â†“Â¨2âŠË˜ğ•©
			  # unique commodities
			  com â† â·t
			  # amount array by commodities
			  am â† (Ã—Â´Ë˜âŠ‘Ë˜2â†‘Â¨2â†“Ë˜ğ•©)Ã—tâ‰¡âŒœcom
			  comâ€¿am
}

comâ€¿am â† CommodityCols k

RemCommodityCols â† {
				 (<Â¨(â‰ ğ•¨)/1â†‘Ë˜ğ•©)âˆ¾Â¨â¥Š<Â¨(âŸ¨â‰ ğ•©, â‰ ğ•¨âŸ©â¥Š1)âˆ¾Â¨(<Â¨âŸ¨â‰ ğ•©, â‰ ğ•¨âŸ©â¥Šğ•¨)âˆ¾Â¨(1â†“Ë˜ğ•©)
}
	
# Overflow rows for balancing
ErrorRows â† {
	  amâ€¿jâ€¿k :
	  # empty TAs are used for balancing
	  e â† 0=+Â´Ë˜am
	  # add empty posting fallback
	  em â† (1â†‘Ë˜j)(Â¬âˆ˜âˆŠ/âŠ£)(e/1â†‘Ë˜k)
	  # append fallback rows 
	  t â† kâˆ¾(â‰âˆ¾â‰Â¨âŸ¨em,(â‰ em)/â‰âŸ¨err, of, âŸ¨âŸ©âŸ©âŸ©)
	  # put fallback rows to right index
	  tâŠËœâ‹({ğ•©â‰¡of}Â¨(2âŠË˜t))+2Ã—1â†‘Ë˜t
}

k0 â† ErrorRows amâ€¿jâ€¿k
comâ€¿am â†© CommodityCols k0

# balanced TAs
bal â† â‰âˆ¾â‰Â¨âŸ¨2â†‘Ë˜k0, am+Â¯1Ã—-âŸœÂ»{ğ•¨>â—‹|ğ•©?ğ•¨;ğ•©}`(0=+Â´Ë˜am)Ã—+`amâŸ©

# Find balancing errors
BalancingErrors â† {
				âŸ¨k, bâŸ©:
				# an error row may contain a currency exchange	
				e0 â† ({errâ‰¡ğ•©}Â¨1âŠË˜k)âˆ§Â¬({0=+Â´ğ•©}âˆ§{2=+Â´|Â¨ğ•©})Ë˜Ã—Â¨2â†“Ë˜b
				# an overflow row may contain one currency
				o0 â† {({ofâ‰¡ğ•©}Â¨2âŠË˜k)âˆ§Â¬{errâ‰¡ğ•©}Â¨1âŠË˜k}Ã—Â¬({2>+Â´|Â¨ğ•©})Ë˜Ã—Â¨2â†“Ë˜b
				m â† b/Ëœ0<Â¨e0+o0
}
errs â† BalancingErrors âŸ¨k0, balâŸ©

# match ğ•© to ğ•¨ based on id in first col
MatchFirst â† {
		  âŸ¨ğ•¨,ğ•©âŠËœğ•¨âŠâ—‹(âŠ‘Ë˜)ğ•©âŸ©
}
errs MatchFirst j

RemErrorRows â† {ğ•©/Ëœ{errâ‰¢ğ•©}Â¨1âŠË˜ğ•©}
bal â†© RemErrorRows bal


# # calculate parent indexes from sorted depths
# DepthParents â† { âŒˆÂ´Ë˜(ğ•©=âŒœ1+Ëœâ†•âŒˆÂ´ğ•©)Ã—âŒˆ`(â†•â‰ ğ•©)Ã—ğ•©=âŒœâ†•âŒˆÂ´ğ•© }

# # create account tree
# AccountTree â† {
# 			t â† (âˆ§â·âˆ¾{{ğ•¨âˆ¾":"âˆ¾ğ•©}`ğ•©âŠ”Ëœ1-Ëœ(ğ•©â‰ ':')Ã—1++`ğ•©=':'}Â¨ğ•©)
# 			dep â† (+Â´Â¨t=Â¨':')
# 			par â† DepthParents dep
# 			âŸ¨t, dep, parâŸ©
# }

# AccountTree âŠË˜bal_sums

# multiple commodities unbalanced
1<+Â´Ë˜0â‰ bal
