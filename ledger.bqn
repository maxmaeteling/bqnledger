ns_parser â† â€¢Import "parse.bqn"
âŸ¨Journal, ParseJournalâŸ©â‡ns_parser


input â† â€¢FChars "test.ledger"

jâ€¿k â† ParseJournal input

AmountCols â† {
		   # commodity per TA
		   t â† âŠ‘Â¨2â†“Â¨2âŠË˜ğ•©
		   # unique commodities
		   com â† â·t
		   # amount array by commodities
		   am â† (Ã—Â´Ë˜âŠ‘Ë˜2â†‘Â¨2â†“Ë˜ğ•©)Ã—tâ‰¡âŒœcom
		   comâ€¿am
}

comâ€¿am â† AmountCols k

# empty TAs are used for balancing
e â† 0=+Â´Ë˜am

# add empty posting fallback
em â† (1â†‘Ë˜j)(Â¬âˆ˜âˆŠ/âŠ£)(e/1â†‘Ë˜k)

# add fallback rows at end and put them to right position
tmp â† kâˆ¾(â‰âˆ¾â‰Â¨âŸ¨em,(â‰ em)/â‰"System:Error"â€¿âŸ¨1, 0, -1âŸ©â€¿âŸ¨âŸ©âŸ©)
k0 â† tmpâŠËœâ‹({ğ•©â‰¡âŸ¨1, 0, -1âŸ©}Â¨(2âŠË˜tmp))+2Ã—1â†‘Ë˜tmp

comâ€¿am â†© AmountCols k0

# balanced TAs
bal â† â‰âˆ¾â‰Â¨âŸ¨2â†‘Ë˜k0, am+Â¯1Ã—-âŸœÂ»âŒˆ`(0=+Â´Ë˜am)Ã—+`amâŸ©

# calculate account balance
CalcBal â† {
		# sort/ group accounts
		s â† ğ•©âŠËœâ‹1âŠË˜ğ•©

		# last in group?
		l â† â‰¢Â¨âŸœÂ«1âŠË˜s

		# merge dependent cumulative sums and accounts
		â‰âˆ¾â‰Â¨âŸ¨â‰â‰l/(1âŠË˜s),-âŸœÂ»l/+`2â†“Ë˜sâŸ©
}

CalcBal bal


# multiple commodities unbalanced
1<+Â´Ë˜0â‰ bal
